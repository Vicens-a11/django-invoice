{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container mt-4">

  <!-- ACTIONS -->
  <div class="row mb-4 text-center">
    <div class="col-md-4">
      <a href="{% url 'add_invoice' %}" class="btn btn-primary w-100">
        Register a new invoice
      </a>
    </div>

    <div class="col-md-4"></div>

    <div class="col-md-4">
      <a href="{% url 'add_customer' %}" class="btn btn-primary w-100">
        Register a new client
      </a>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="mb-3">
    <input
      type="text"
      id="search"
      class="form-control"
      placeholder="Search..."
    />
  </div>

  <!-- TABLE -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Customer</th>
          <th>Date</th>
          <th>Total</th>
          <th>Paid</th>
          <th>Invoice Type</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody id="myTable">
        {% if invoices %}
          {% for facture in invoices %}
          <tr>
            <td>{{ facture.pk }}</td>
            <td>{{ facture.customer.name }}</td>
            <td>{{ facture.invoice_date_time }}</td>
            <td>{{ facture.get_total }}</td>

            <td>
              {% if facture.paid %}
                <img src="{% static 'images/icon-yes.svg' %}" width="20">
              {% else %}
                <img src="{% static 'images/icon-no.svg' %}" width="20">
              {% endif %}
            </td>

            <td>{{ facture.invoice_type }}</td>

            <td>
              <a href="#" class="badge bg-success text-white">View</a>

              <button
                type="button"
                class="badge bg-warning text-dark btn-invoice-mod"
                data-bs-toggle="modal"
                data-bs-target="#modifier"
                data-id="{{ facture.pk }}"
              >
                Modify
              </button>

              <button
                type="button"
                class="badge bg-danger text-white btn-invoice-sup"
                data-bs-toggle="modal"
                data-bs-target="#supprimer"
                data-id="{{ facture.pk }}"
              >
                Delete
              </button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="7" class="text-center">
              No invoice found.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>

<!-- MODAL MODIFY -->
<div class="modal fade" id="modifier" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Update Invoice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id_modified" id="id_modified">

          <p>Has this invoice been paid?</p>

          <div class="form-check">
            <input class="form-check-input" type="radio" name="modified" value="True">
            <label class="form-check-label">Yes</label>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="radio" name="modified" value="False">
            <label class="form-check-label">No</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal fade" id="supprimer" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">Delete Invoice</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id_supprimer" id="id_supprimer">
          <p>Are you sure you want to delete this invoice?</p>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
  // Fill modal inputs
  document.addEventListener("click", function (e) {
    if (e.target.classList.contains("btn-invoice-mod")) {
      document.getElementById("id_modified").value = e.target.dataset.id;
    }

    if (e.target.classList.contains("btn-invoice-sup")) {
      document.getElementById("id_supprimer").value = e.target.dataset.id;
    }
  });

  // Search filter
  document.getElementById("search").addEventListener("keyup", function () {
    let value = this.value.toLowerCase();
    document.querySelectorAll("#myTable tr").forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(value)
        ? ""
        : "none";
    });
  });
</script>

{% endblock %}
